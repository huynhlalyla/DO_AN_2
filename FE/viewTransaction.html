<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản lý Giao dịch</title>
    <link rel="stylesheet" href="../FE/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
    .line-chart {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 70%;
        margin: auto;
    }
    .line-chart canvas {
        width: 100% !important;
        height: auto !important;
    }
    .modal-content{
        padding: 10px;
    }
</style>
<body>
    <div id="header"></div>
    <div class="container mt-4">
        <h3 class="text-center">Thống kê chi tiêu & thu nhập</h3>
        <div class="line-chart">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
    <div class="container mt-4">
        <!-- test cái options -->
        <select name="" id="choice-option" class="form-select mb-4">
            <option value="7">Thống kê 1 tuần</option>
            <option value="14">Thống kê 2 tuần</option>
            <option value="30" selected>Thống kê 1 tháng</option>
            <option value="60">Thống kê 2 tháng</option>
            <option value="90">Thống kê 3 tháng</option>
         </select>
         <div>
            <span style="font-size: 16px; color: orangered;" id="start-date"></span>
            <span style="font-size: 16px; color: orangered;"> - </span>
            <span style="font-size: 16px; color: orangered;" id="end-date"></span>
         </div>
        <h2 class="mb-3 text-center">Danh sách chi tiêu & thu nhập</h2>
        <div class="table-container">
            <table class="table table-bordered table-striped text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Tên giao dịch</th>
                        <th>Danh mục</th>
                        <th>Loại danh mục</th>
                        <th>Số tiền</th>
                        <th>Ngày</th>
                        <th>Chức năng</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    
                </tbody>
            </table>
        </div>
                <!-- Modal chỉnh sửa giao dịch -->
        <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-center w-100" id="editTransactionLabel">Chỉnh sửa giao dịch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editTransactionForm">
                            <div class="mb-3">
                                <label class="form-label">Tên giao dịch</label>
                                <input type="text" class="form-control" id="editTransactionName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Danh mục</label>
                                <input type="text" class="form-control" id="editCategory" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Loại danh mục</label>
                                <select class="form-control" id="editCategoryType">
                                    <option value="Chi tiêu">Chi tiêu</option>
                                    <option value="Thu nhập">Thu nhập</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số tiền</label>
                                <input type="text" class="form-control" id="editAmount" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" id="editDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary text-center w-100">Lưu thay đổi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="footer"></div>
    <script src="../FE/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let currentRow = null;
        
            document.querySelectorAll(".edit-btn").forEach((button) => {
                button.addEventListener("click", function () {
                    currentRow = this.closest("tr");
                    let transactionName = currentRow.cells[0].textContent;
                    let category = currentRow.cells[1].textContent;
                    let categoryType = currentRow.cells[2].textContent;
                    let amount = currentRow.cells[3].textContent.replace(" VND", "").trim();
                    
                    let dateParts = currentRow.cells[4].textContent.split("/");
                    let date = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
            
                    document.getElementById("editTransactionName").value = transactionName;
                    document.getElementById("editCategory").value = category;
                    document.getElementById("editCategoryType").value = categoryType;
                    document.getElementById("editAmount").value = amount;
                    document.getElementById("editDate").value = date;
                });
            });            
            document.getElementById("editTransactionForm").addEventListener("submit", function (event) {
                event.preventDefault();
        
                if (currentRow) {
                    currentRow.cells[0].textContent = document.getElementById("editTransactionName").value;
                    currentRow.cells[1].textContent = document.getElementById("editCategory").value;
                    currentRow.cells[2].textContent = document.getElementById("editCategoryType").value;
                    currentRow.cells[3].textContent = document.getElementById("editAmount").value + " VND";
                    currentRow.cells[4].textContent = document.getElementById("editDate").value.split("-").reverse().join("/");
                }
        
                // Đóng modal
                let editModal = bootstrap.Modal.getInstance(document.getElementById("editTransactionModal"));
                editModal.hide();
            });
        });
        
        document.addEventListener("DOMContentLoaded", function () {
            let currentChart = null;
        
            const selectOption = document.getElementById('choice-option');
            selectOption.addEventListener('change', function () {
                const selectedValue = this.value;
                chartRendering(parseInt(selectedValue));
            });

            function renderTable(data) {
                const transactions = data.transactions; // Lấy danh sách giao dịch từ dữ liệu trả về
                const transactionTableBody = document.getElementById("transactionTableBody");
                transactionTableBody.innerHTML = ""; // Xóa nội dung cũ

                //thời gian bắt đầu và kết thúc
                const startDate = document.getElementById('start-date');
                const endDate = document.getElementById('end-date');
                startDate.innerText = new Date(data.startDate).toLocaleDateString('vi-VN');;
                endDate.innerText = new Date(data.endDate).toLocaleDateString('vi-VN');;

                //kiểm tra xem có giao dịch nào không
                if (transactions.length === 0) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="6" style="color: red;">Bạn chưa có giao dịch nào!</td>`;
                    transactionTableBody.appendChild(row);
                    return;
                }
                transactions.forEach(transaction => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${transaction.name}</td>
                        <td>${transaction.category_id.name}</td>
                        <td>${transaction.type === "expense" ? "Chi tiêu" : "Thu nhập"}</td>
                        <td>${parseFloat(transaction.amount).toLocaleString()} đ</td>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-warning btn-sm me-1 edit-btn" data-bs-toggle="modal" data-bs-target="#editTransactionModal">
                                <i class="bi bi-pencil-square"></i>
                            </button>                            
                            <button class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
                        </td>`;
                    transactionTableBody.appendChild(row);
                });
            }
            async function chartRendering(day) {
            const userId = JSON.parse(localStorage.getItem('user')).id; // Lấy user_id từ localStorage
            console.log(userId);


            //call API để lấy dữ liệu giao dịch của người dùng bằng đối tương report
            //call API dựa trên user_id(lúc đăng nhập có)
            const response = await fetch('http://localhost:3000/report/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    day: day
                })
            });
            
            const data = await response.json();
            console.log(data);
            //cập nhật dữ liệu thu nhập và chi tiêu của người dùng từ server
            let TOTAL_INCOME = data.total_income;
            let TOTAL_EXPENSE = data.total_expense;
            let TRANSACTIONS = data.transactions;

            let totalIncome = 0;
            //dùng 2 dòng for để truy cập vào từng giao dịch của thu nhập và chi tiêu
            TOTAL_INCOME.forEach(income => {
                totalIncome += parseFloat(income.amount);
            })
            let totalExpense = 0;
            //dùng 2 dòng for để truy cập vào từng giao dịch của thu nhập và chi tiêu
            TOTAL_EXPENSE.forEach(expense => {
                totalExpense += parseFloat(expense.amount);
            })
            //tính số dư
            let balance = totalIncome - totalExpense;
            
            //sắp xếp ngày tăng dần trước khi vẽ biểu đồ
            TRANSACTIONS.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sắp xếp theo ngày giảm dần
            renderTable(data); // Gọi hàm renderTable để hiển thị dữ liệu trên bảng

            let labels = [];
            let expenseValues = [];
            let incomeValues = [];

            // Chuyển đổi dữ liệu thành mảng và nạp vào vị trí hợp lí 
            TRANSACTIONS.forEach(transaction => {
                const date = new Date(transaction.date).toLocaleDateString("vi-VN", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit"
                });
                labels.push(date);
                if(transaction.type === "expense") {
                    expenseValues.push(transaction.amount);
                    incomeValues.push(0); // Đặt giá trị thu nhập là 0 cho ngày này
                } else if(transaction.type === "income") {
                    incomeValues.push(transaction.amount);
                    expenseValues.push(0); // Đặt giá trị chi tiêu là 0 cho ngày này
                }
            });
            console.log(labels, expenseValues, incomeValues);
            // Vẽ biểu đồ
            // Xóa biểu đồ cũ nếu có
            if (currentChart) {
                currentChart.destroy();
            }
            const ctx = document.getElementById("lineChart").getContext("2d");
            currentChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Chi tiêu",
                            data: expenseValues,
                            borderColor: "red",
                            backgroundColor: "rgba(255, 0, 0, 0.2)",
                            borderWidth: 2,
                            tension: 0.4,
                        },
                        {
                            label: "Thu nhập",
                            data: incomeValues,
                            borderColor: "blue",
                            backgroundColor: "rgba(0, 0, 255, 0.2)",
                            borderWidth: 2,
                            tension: 0.4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "top",
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Số tiền (VND)"
                            }
                        },
                    }
                }
            });
        }
        chartRendering(30); // Gọi hàm với số ngày bạn muốn lấy dữ liệu
        });
    </script>
</body>
</html>
