<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω T√†i Kho·∫£n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../FE/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
    <style>
        .modal-content{
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="loader-container" style="display: none;">
        <span class="loader"></span>
    </div>
<div id="header"></div>
<div class="container mt-4">
    <div class="card p-4 mx-auto" style="max-width: 500px;"> <!-- Gi·ªõi h·∫°n chi·ªÅu r·ªông -->
        <h4 class="text-center">Th√¥ng tin t√†i kho·∫£n</h4>
        <div class="mb-3">
            <label class="form-label">T√™n ng∆∞·ªùi d√πng</label>
            <input type="text" id="user-name" class="form-control" value="">
        </div>
        <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="user-email" class="form-control" value="">
        </div>
        <div class="mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" id="user-phone" class="form-control" value="">
        </div>
        <div class="d-flex justify-content-center gap-3">
            <button id="save-info-btn" class="btn btn-success">L∆∞u th√¥ng tin</button>
            <button id="change-password-btn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#passwordModal">ƒê·ªïi m·∫≠t kh·∫©u</button>
        </div>
    </div>
    <div class="card p-4 mt-4 mx-auto"style="max-width: 500px;">
        <h4 class="text-center">Xu·∫•t d·ªØ li·ªáu t√†i ch√≠nh</h4>
        <div class="d-flex justify-content-center gap-3">
            <button id="export-pdf" class="btn btn-danger">Xu·∫•t PDF</button>
        </div>
    </div>
</div>
<div id="footer"></div>
<div id="chart-container" style="display: none;">
    <canvas id="incomeExpenseChart" width="400" height="400"></canvas>
</div>

<!-- Modal ƒê·ªïi M·∫≠t Kh·∫©u -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center w-100" id="passwordModalLabel">ƒê·ªïi M·∫≠t Kh·∫©u</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                </div>
                <div class="mb-3">
                    <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                </div>
                <div class="mb-3">
                    <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center gap-3">
                <button id="save-password-btn" class="btn btn-success">L∆∞u m·∫≠t kh·∫©u</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">H·ªßy thay ƒë·ªïi</button>
            </div>            
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="../FE/js/main.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async function() {
        //load data user
        const userId = JSON.parse(sessionStorage.getItem("user")).id;
        showLoader(true);
        const respone = await fetch("http://localhost:3000/user/get-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ userId: userId })
        });
        const data = await respone.json();
        showLoader(false);
        const user = data.user;
        document.getElementById("user-name").value = user.name;
        document.getElementById("user-email").value = user.email;
        document.getElementById("user-phone").value = user.phone;

        //update
        document.getElementById("save-info-btn").addEventListener("click", async function() {
            const userName = document.getElementById("user-name").value;
            const userEmail = document.getElementById("user-email").value;
            const userPhone = document.getElementById("user-phone").value;
            const userId = JSON.parse(sessionStorage.getItem("user")).id;
            console.log(userId);
            if (!userName || !userEmail || !userPhone) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            showLoader(true);
            const respone = await fetch("http://localhost:3000/user/update", {
                method: "put",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    userId: userId,
                    newName: userName,
                    newEmail: userEmail,
                    newPhone: userPhone,
                })
            });
            const data = await respone.json();
            showLoader(false);
            alert(data.message);
        });

        //change password
        document.getElementById("save-password-btn").addEventListener("click", async function() {
            let currentPassword = document.getElementById("current-password").value;
            let newPassword = document.getElementById("new-password").value;
            let confirmPassword = document.getElementById("confirm-password").value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!");
                return;
            }
            
            const userId = JSON.parse(sessionStorage.getItem("user")).id;
            showLoader(true);
            const respone = await fetch("http://localhost:3000/user/change-password", {
                method: "put",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    userId: userId,
                    currentPassword: currentPassword,
                    newPassword: newPassword,
                })
            });
            const data = await respone.json();
            showLoader(false);
            console.log(data);
            
            //t·∫Øt modal v√† clear input
            alert(data.message);
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
            var modal = bootstrap.Modal.getInstance(document.getElementById("passwordModal"));
            modal.hide();
        });
    });

    

    document.getElementById("export-pdf").addEventListener("click", async function () {
    const userId = JSON.parse(sessionStorage.getItem("user")).id;

    // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng
    showLoader(true);
    const userResponse = await fetch("http://localhost:3000/user/get-user", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ userId: userId }),
    });
    const userData = await userResponse.json();
    showLoader(false);
    const user = userData.user;

    // L·∫•y d·ªØ li·ªáu t√†i ch√≠nh
    showLoader(true);
    const reportResponse = await fetch("http://localhost:3000/report/create", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ user_id: userId, day: 30 }),
    });
    const reportData = await reportResponse.json();
    showLoader(false);
    const totalIncome = parseFloat(reportData.total_income.reduce((sum, t) => sum + parseFloat(t.amount), 0));
    const totalExpense = parseFloat(reportData.total_expense.reduce((sum, t) => sum + parseFloat(t.amount), 0));
    const balance = totalIncome - totalExpense;
    const transactions = reportData.transactions;

     // ƒê∆∞·ªùng d·∫´n logo (c·∫ßn ƒë·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y h·ª£p l·ªá)
     const logoUrl = "../FE/css/image/logo.png";

    // T·∫£i logo v√† chuy·ªÉn ƒë·ªïi th√†nh Base64
    showLoader(true);
    const logoResponse = await fetch(logoUrl);
    const logoBlob = await logoResponse.blob();
    const logoBase64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(logoBlob);
    });
    showLoader(false);

    document.getElementById("chart-container").style.display = "block"; // Hi·ªán bi·ªÉu ƒë·ªì tr∆∞·ªõc khi xu·∫•t PDF
    const ctx = document.getElementById("incomeExpenseChart").getContext("2d");
    const chart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["Thu nh·∫≠p", "Chi ti√™u"],
            datasets: [
                {
                    data: [totalIncome, totalExpense],
                    backgroundColor: ["#4CAF50", "#F44336"],
                },
            ],
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 16, // üëà TƒÉng c·ª° ch·ªØ c·ªßa legend
                            weight: 'bold' // üëà ƒê·∫≠m ch·ªØ
                        },
                        padding: 20,
                    },
                    position: "right",
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 16 // üëà TƒÉng c·ª° ch·ªØ tr√™n l√°t c·∫Øt (n·∫øu ƒëang b·∫≠t datalabels)
                    },
                    formatter: (value, ctx) => {
                        let label = ctx.chart.data.labels[ctx.dataIndex];
                        return `${label}: ${value.toLocaleString()} ƒë`;
                    }
                }
            }
        },
        plugins: [ChartDataLabels] // N·∫øu b·∫°n ƒëang d√πng chartjs-plugin-datalabels
    });
    // Ch·ªù bi·ªÉu ƒë·ªì ƒë∆∞·ª£c v·∫Ω xong
    await new Promise((resolve) => setTimeout(resolve, 1000));

    // Chuy·ªÉn ƒë·ªïi bi·ªÉu ƒë·ªì th√†nh h√¨nh ·∫£nh Base64
    const chartBase64 = await chart.toBase64Image();
    document.getElementById("chart-container").style.display = "none"; // ·∫®n bi·ªÉu ƒë·ªì sau khi xu·∫•t PDF

    // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ giao d·ªãch
    if (transactions.length === 0) {
        const docDefinition = {
            content: [
                {
                    image: logoBase64,
                    width: 50, // K√≠ch th∆∞·ªõc logo
                    alignment: "left",
                    margin: [0, 0, 0, 10], // CƒÉn l·ªÅ
                },
                { text: "B√°o C√°o T√†i Ch√≠nh", style: "header" },
                { text: "Ng√†y: " + new Date().toLocaleDateString(), margin: [0, 10] },
                { text: "Th√¥ng Tin Ng∆∞·ªùi D√πng", style: "subheader", margin: [0, 10] },
                { text: `H·ªç v√† t√™n: ${user.name}`, margin: [0, 5] },
                { text: `Email: ${user.email}`, margin: [0, 5] },
                { text: `S·ªë ƒëi·ªán tho·∫°i: ${user.phone}`, margin: [0, 5] },
                { text: `Ng√†y t·∫°o t√†i kho·∫£n: ${new Date(user.createdAt).toLocaleDateString("vi-VN")}`, margin: [0, 5] },
                { text: `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date(user.updatedAt).toLocaleDateString("vi-VN")}`, margin: [0, 5] },
                { text: "T√†i kho·∫£n ch∆∞a c√≥ giao d·ªãch n√†o trong 30 ng√†y g·∫ßn nh·∫•t.", margin: [0, 10], color: "red" },
            ],
            styles: {
                header: { fontSize: 18, bold: true, alignment: "center" },
                subheader: { fontSize: 14, bold: true },
            },
        };

        // Xu·∫•t file PDF
        pdfMake.createPdf(docDefinition).download("bao_cao_tai_chinh.pdf");
        return;
    }

    // T·∫°o n·ªôi dung PDF khi c√≥ giao d·ªãch
    const docDefinition = {
        content: [
            {
                image: logoBase64,
                width: 50, // K√≠ch th∆∞·ªõc logo
                alignment: "left",
                margin: [0, 0, 0, 10], // CƒÉn l·ªÅ
            },
            { text: "B√°o C√°o T√†i Ch√≠nh", style: "header" },
            { text: "Ng√†y: " + new Date().toLocaleDateString(), margin: [0, 10] },
            { text: "Th√¥ng Tin Ng∆∞·ªùi D√πng", style: "subheader", margin: [0, 10] },
            { text: `H·ªç v√† t√™n: ${user.name}`, margin: [0, 5] },
            { text: `Email: ${user.email}`, margin: [0, 5] },
            { text: `S·ªë ƒëi·ªán tho·∫°i: ${user.phone}`, margin: [0, 5] },
            { text: `Ng√†y t·∫°o t√†i kho·∫£n: ${new Date(user.createdAt).toLocaleDateString("vi-VN")}`, margin: [0, 5] },
            { text: `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date(user.updatedAt).toLocaleDateString("vi-VN")}`, margin: [0, 5] },
            { text: "T·ªïng Quan T√†i Ch√≠nh", style: "subheader", margin: [0, 10] },
            {
            columns: [
                {
                    width: '*',
                    stack: [
                        { text: `T·ªïng Thu Nh·∫≠p: ${totalIncome.toLocaleString()} ƒë`, margin: [0, 5] },
                        { text: `T·ªïng Chi Ti√™u: ${totalExpense.toLocaleString()} ƒë`, margin: [0, 5] },
                        { text: `S·ªë d∆∞: ${balance.toLocaleString()} ƒë`, margin: [0, 5] },
                    ]
                },
                {
                    width: 'auto',
                    stack: [
                        { text: 'Bi·ªÉu ƒë·ªì t√†i ch√≠nh', alignment: 'center', margin: [0, 0, 0, 5], bold: true },
                        {
                            image: chartBase64,
                            width: 200,
                            margin: [5, 0, 0, 0]
                        },
                        { text: 'Ngu·ªìn: Bi·ªÉu ƒë·ªì t·ªïng h·ª£p', fontSize: 9, alignment: 'center', margin: [0, 5, 0, 0], italics: true }
                    ]
                }
            ],
            columnGap: 5,
        },

            { text: "Danh S√°ch Giao D·ªãch", style: "subheader", margin: [0, 10] },
            {
                table: {
                    headerRows: 1,
                    widths: ["*", "*", "*", "*"],
                    body: [
                        ["T√™n Giao D·ªãch", "Lo·∫°i", "S·ªë Ti·ªÅn", "Ng√†y"],
                        ...transactions.map((t) => [
                            t.name,
                            t.type === "income" ? "Thu nh·∫≠p" : "Chi ti√™u",
                            `${parseInt(t.amount).toLocaleString()} ƒë`,
                            new Date(t.date).toLocaleDateString("vi-VN"),
                        ]),
                    ],
                },
            },
        ],
        styles: {
            header: { fontSize: 18, bold: true, alignment: "center" },
            subheader: { fontSize: 14, bold: true },
        },
    };

    // Xu·∫•t file PDF
    pdfMake.createPdf(docDefinition).download("bao_cao_tai_chinh.pdf");
});
    

    
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>